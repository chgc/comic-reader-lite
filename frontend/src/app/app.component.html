<!-- Mobile floating button: only when no comic is open (reader header unavailable) -->
@if (!currentComic()) {
  <button class="panel-toggle" (click)="showPanel.set(true)" aria-label="é–‹å•Ÿé¸å–®">â˜°</button>
}

<!-- Backdrop for mobile drawer -->
@if (showPanel()) {
  <div class="panel-backdrop" (click)="showPanel.set(false)"></div>
}

<main class="layout">
  <!-- â”€â”€ Left panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <section class="panel" [class.open]="showPanel()">
    <div class="panel-header">
      <h1>8comic ä¹¾æ·¨ç‰ˆ</h1>
      <button class="panel-close" (click)="showPanel.set(false)" aria-label="é—œé–‰">âœ•</button>
    </div>

    <!-- Tabs -->
    <div class="tab-bar">
      <button class="tab-btn" [class.active]="activeTab() === 'add'" (click)="activeTab.set('add')">ï¼‹ æ–°å¢</button>
      <button class="tab-btn" [class.active]="activeTab() === 'history'" (click)="activeTab.set('history')">
        ğŸ“š æ­·å²
        @if (comics().length) {
          <span class="tab-badge">{{ comics().length }}</span>
        }
      </button>
    </div>

    <!-- Tab: Add new comic -->
    @if (activeTab() === 'add') {
      <div class="tab-content">
        <form class="add-form" (ngSubmit)="addComic()">
          <input [(ngModel)]="newComicId" name="comicId" placeholder="æ¼«ç•« ID" required />
          <button type="button" (click)="fetchDraftChapters()" [disabled]="!newComicId.trim()">å–å¾—ç« ç¯€</button>
          @if (draftComicTitle()) {
            <p>æ¼«ç•«åç¨±ï¼š{{ draftComicTitle() }}</p>
          }
          <select [(ngModel)]="newChapter" name="chapter">
            @for (c of draftChapters(); track c.id) {
              <option [value]="c.id">{{ c.id }} - {{ c.title }}</option>
            }
          </select>
          <button type="submit" [disabled]="!newComicId.trim() || !newChapter.trim()">é–±è®€</button>
        </form>
        @if (chapterError()) {
          <p class="error">{{ chapterError() }}</p>
        }
      </div>
    }

    <!-- Tab: Reading history -->
    @if (activeTab() === 'history') {
      <div class="tab-content">
        @if (comics().length === 0) {
          <p class="empty-hint">å°šç„¡é–±è®€ç´€éŒ„ï¼Œåˆ‡æ›åˆ°ã€Œæ–°å¢ã€é ç±¤åŠ å…¥æ¼«ç•«</p>
        }
        <ul class="comic-list">
          @for (comic of comics(); track comic.id) {
            <li [class.active-comic]="currentComic()?.id === comic.id">
              <button (click)="openComic(comic)">
                <span class="comic-title">{{ comic.title }}</span>
                <span class="comic-meta"
                  >ch{{ comic.chapter
                  }}{{
                    progressMap()[comic.id]?.pageIndex ? ' Â· ç¬¬' + (progressMap()[comic.id]!.pageIndex + 1) + 'é ' : ''
                  }}</span
                >
              </button>
              <button class="danger" (click)="removeComic(comic.id)">ç§»é™¤</button>
            </li>
          }
        </ul>
      </div>
    }
  </section>

  <!-- â”€â”€ Reader â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  @if (currentComic()) {
    <section class="reader">
      <!-- Sticky top: header + chapter picker -->
      <div class="reader-top">
        <div class="reader-header">
          <button class="btn-tool mobile-menu-btn" (click)="showPanel.set(true)" aria-label="é¸å–®">â˜°</button>
          <h2 class="reader-title">{{ currentComic()!.title }} â€” ç¬¬ {{ currentChapter() }} é›†</h2>
          <div class="reader-toolbar">
            <button class="btn-tool" (click)="toggleChapterPicker()">â˜° ç« ç¯€</button>
          </div>
        </div>

        <!-- Chapter quick-picker -->
        @if (showChapterPicker()) {
          <div class="chapter-picker">
            @if (comicChapters().length === 0) {
              <span class="picker-loading">è¼‰å…¥ä¸­â€¦</span>
            }
            @for (c of comicChapters(); track c.id) {
              <button class="chapter-btn" [class.active]="c.id === currentChapter()" (click)="jumpToChapter(c.id)">
                {{ c.id }}
              </button>
            }
          </div>
        }
      </div>

      @if (error()) {
        <p class="error">{{ error() }}</p>
      }
      @if (loading()) {
        <div class="loading-indicator">è¼‰å…¥ä¸­â€¦</div>
      }

      @if (!loading() && pages().length > 0) {
        <div class="scroll-reader" #scrollReader (scroll)="onScrollReaderScroll($event)">
          @for (url of pages(); track $index) {
            <div class="scroll-page-wrap">
              @defer (on viewport) {
                <img [src]="url" loading="lazy" [alt]="'ç¬¬ ' + ($index + 1) + ' é '" class="scroll-page-img" />
              } @placeholder {
                <div class="scroll-page-placeholder"></div>
              }
            </div>
          }
        </div>
      }

      <div class="chapter-nav">
        <button (click)="prevChapter()" [disabled]="!hasPrevChapter()">â† ä¸Šä¸€ç« </button>
        <span class="chapter-nav-label">ç¬¬ {{ currentChapter() }} é›†</span>
        <button (click)="nextChapter()" [disabled]="!hasNextChapter()">ä¸‹ä¸€ç«  â†’</button>
      </div>
    </section>
  } @else {
    <div class="no-comic-hint">
      <p>å¾å·¦å´é¸å–æ¼«ç•«ï¼Œæˆ–åˆ‡æ›åˆ°ã€Œæ–°å¢ã€é ç±¤åŠ å…¥æ–°æ¼«ç•«</p>
    </div>
  }
</main>
